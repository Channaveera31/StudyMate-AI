<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Scanner - StudyMate AI</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        --dark: #1a1a2e;
        --light: #eee;
        --glass: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.2);
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
        background-size: 400% 400%;
        animation: gradientShift 15s ease infinite;
        min-height: 100vh;
        color: white;
        overflow-x: hidden;
      }

      @keyframes gradientShift {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        position: relative;
      }

      /* Floating particles background */
      .particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
          opacity: 0;
        }
        50% {
          transform: translateY(-100px) rotate(180deg);
          opacity: 1;
        }
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 20px 30px;
        margin-bottom: 30px;
        animation: slideDown 0.8s ease-out;
        position: relative;
        z-index: 10;
      }

      .back-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 24px;
        background: var(--glass);
        border: none;
        border-radius: 16px;
        color: white;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .back-btn:before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .back-btn:hover:before {
        left: 100%;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }

      .header h1 {
        font-size: 2.2rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 15px;
        background: linear-gradient(135deg, #fff, #f0f8ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--success);
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .pulse {
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.7;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        position: relative;
        z-index: 10;
      }

      .card {
        background: var(--glass);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 30px;
        animation: slideUp 0.8s ease-out;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .card:before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary);
        transform: scaleX(0);
        transition: transform 0.3s ease;
      }

      .card:hover:before {
        transform: scaleX(1);
      }

      .section-title {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
        color: white;
      }

      /* Upload Section */
      .upload-area {
        border: 3px dashed rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 40px 20px;
        text-align: center;
        background: rgba(255, 255, 255, 0.05);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .upload-area:before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 70%
        );
        transition: all 0.3s ease;
        transform: translate(-50%, -50%);
        border-radius: 50%;
      }

      .upload-area:hover:before {
        width: 300px;
        height: 300px;
      }

      .upload-area:hover {
        border-color: rgba(255, 255, 255, 0.6);
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.02);
      }

      .upload-area.dragover {
        border-color: #4facfe;
        background: rgba(79, 172, 254, 0.1);
        transform: scale(1.05);
      }

      .upload-icon {
        font-size: 3.5rem;
        margin-bottom: 20px;
        background: var(--primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
        z-index: 2;
      }

      .upload-text {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 10px;
        position: relative;
        z-index: 2;
      }

      .upload-hint {
        font-size: 0.9rem;
        opacity: 0.8;
        position: relative;
        z-index: 2;
      }

      .upload-btn {
        padding: 15px 30px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.3s ease;
        position: relative;
        z-index: 2;
        overflow: hidden;
      }

      .upload-btn:before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .upload-btn:hover:before {
        left: 100%;
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
      }

      /* Camera Section */
      .camera-container {
        position: relative;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 20px;
        overflow: hidden;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(255, 255, 255, 0.1);
      }

      #camera {
        width: 100%;
        height: auto;
        border-radius: 20px;
        object-fit: cover;
      }

      .camera-placeholder {
        text-align: center;
        font-size: 1.1rem;
        opacity: 0.7;
      }

      .camera-controls {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        justify-content: center;
      }

      .camera-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
      }

      .camera-btn:before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .camera-btn:hover:before {
        left: 100%;
      }

      .start-camera-btn {
        background: var(--success);
        color: white;
      }

      .capture-btn {
        background: var(--secondary);
        color: white;
      }

      .camera-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }

      /* Preview Section */
      .preview-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 20px;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
      }

      #previewImg {
        max-width: 100%;
        max-height: 100%;
        border-radius: 16px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        transition: all 0.5s ease;
      }

      #previewImg:hover {
        transform: scale(1.05);
      }

      .preview-placeholder {
        text-align: center;
        font-size: 1.1rem;
        opacity: 0.7;
      }

      .preview-overlay {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        gap: 10px;
      }

      .overlay-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .overlay-btn:hover {
        background: white;
        transform: scale(1.1);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      /* Summary Section */
      .summary-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 25px;
        min-height: 200px;
        overflow-y: auto;
        max-height: 400px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .summary-btn {
        width: 100%;
        padding: 18px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        position: relative;
        overflow: hidden;
      }

      .summary-btn:before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .summary-btn:hover:before {
        left: 100%;
      }

      .summary-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      }

      .summary-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .summary-btn:disabled:hover {
        box-shadow: none;
      }

      .summary-content {
        color: white;
        line-height: 1.8;
        font-size: 1rem;
      }

      .summary-placeholder {
        text-align: center;
        font-style: italic;
        opacity: 0.7;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: #4facfe;
        padding: 20px;
      }

      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #4facfe;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        margin: 20px 0;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--success);
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 4px;
        position: relative;
      }

      .progress-fill:after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      @keyframes slideDown {
        0% {
          opacity: 0;
          transform: translateY(-30px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideUp {
        0% {
          opacity: 0;
          transform: translateY(30px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Real-time status indicator */
      .realtime-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: var(--success);
        border-radius: 25px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 0.9rem;
        z-index: 1000;
        animation: slideUp 0.5s ease-out;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .header h1 {
          font-size: 1.8rem;
        }

        .container {
          padding: 15px;
        }

        .card {
          padding: 20px;
        }

        .upload-area {
          padding: 30px 15px;
        }

        .camera-controls {
          flex-direction: column;
          align-items: center;
        }
      }

      /* Tooltip */
      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip:hover:after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        border-radius: 8px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 1000;
        opacity: 1;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        0% {
          opacity: 0;
          transform: translateX(-50%) translateY(10px);
        }
        100% {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <!-- Floating particles background -->
    <div class="particles" id="particles"></div>

    <div class="container">
      <header class="header">
        <a href="dashboard.html" class="back-btn">
          <i class="fas fa-arrow-left"></i>
          Back
        </a>
        <h1>
          <i class="fas fa-camera-retro"></i>
          Smart Scanner
        </h1>
        <div class="status-indicator">
          <div class="pulse"></div>
          Real-time AI
        </div>
      </header>

      <div class="main-grid">
        <div class="card">
          <h2 class="section-title">
            <i class="fas fa-cloud-upload-alt"></i>
            Upload Documents
          </h2>

          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
              <i class="fas fa-file-image"></i>
            </div>
            <div class="upload-text">Drop your files here</div>
            <div class="upload-hint">
              or click to browse (Images, PDFs, Documents)
            </div>
            <input
              type="file"
              id="fileInput"
              style="display: none"
              accept="image/*,.pdf,.doc,.docx"
              multiple
            />
            <button
              class="upload-btn"
              onclick="document.getElementById('fileInput').click()"
            >
              <i class="fas fa-folder-open"></i>
              Choose Files
            </button>
          </div>
        </div>

        <div class="card">
          <h2 class="section-title">
            <i class="fas fa-video"></i>
            Live Camera
          </h2>

          <div class="camera-container">
            <video id="camera" autoplay style="display: none"></video>
            <canvas id="snapshot" style="display: none"></canvas>
            <div id="cameraPlaceholder" class="camera-placeholder">
              <i
                class="fas fa-camera"
                style="font-size: 3rem; margin-bottom: 15px"
              ></i>
              <p>Click "Start Camera" to begin scanning</p>
            </div>
          </div>

          <div class="camera-controls">
            <button
              id="startCamera"
              class="camera-btn start-camera-btn tooltip"
              data-tooltip="Start live camera feed"
            >
              <i class="fas fa-play"></i>
              Start Camera
            </button>
            <button
              id="takePhoto"
              class="camera-btn capture-btn tooltip"
              style="display: none"
              data-tooltip="Capture current frame"
            >
              <i class="fas fa-camera"></i>
              Capture Photo
            </button>
          </div>
        </div>

        <div class="card">
          <h2 class="section-title">
            <i class="fas fa-eye"></i>
            Preview & Edit
          </h2>

          <div class="preview-container" id="previewContainer">
            <div class="preview-placeholder">
              <i
                class="fas fa-image"
                style="font-size: 3rem; margin-bottom: 15px"
              ></i>
              <p>Your scanned image will appear here</p>
            </div>
            <img id="previewImg" style="display: none" alt="Preview" />
            <div class="preview-overlay" style="display: none">
              <button
                class="overlay-btn tooltip"
                onclick="downloadImage()"
                data-tooltip="Download image"
              >
                <i class="fas fa-download"></i>
              </button>
              <button
                class="overlay-btn tooltip"
                onclick="rotateImage()"
                data-tooltip="Rotate image"
              >
                <i class="fas fa-redo"></i>
              </button>
              <button
                class="overlay-btn tooltip"
                onclick="enhanceImage()"
                data-tooltip="Enhance quality"
              >
                <i class="fas fa-magic"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="section-title">
            <i class="fas fa-brain"></i>
            AI Analysis
          </h2>

          <button id="summarizeBtn" class="summary-btn" disabled>
            <i class="fas fa-sparkles"></i>
            Generate AI Summary
          </button>

          <div class="progress-bar" id="progressBar" style="display: none">
            <div class="progress-fill" id="progressFill"></div>
          </div>

          <div class="summary-container">
            <div id="summaryOutput" class="summary-placeholder">
              Upload or capture an image to get real-time AI-powered analysis of
              your documents
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Real-time status indicator -->
    <div class="realtime-status">
      <div class="pulse"></div>
      <span>System Online</span>
    </div>

    <script>
      // ImageKit configuration
      const IMAGEKIT_CONFIG = {
        urlEndpoint: "https://ik.imagekit.io/2v7bpla6v",
        publicKey: "public_aTE5JJek9Za9N0XM4KIgzX2EKAc=",
        privateKey: "private_6RBztjGJtGEe9krpItIvVxO8AdA=",
      };

      // DOM elements
      const fileInput = document.getElementById("fileInput");
      const uploadArea = document.getElementById("uploadArea");
      const camera = document.getElementById("camera");
      const snapshot = document.getElementById("snapshot");
      const startCameraBtn = document.getElementById("startCamera");
      const takePhotoBtn = document.getElementById("takePhoto");
      const cameraPlaceholder = document.getElementById("cameraPlaceholder");
      const previewImg = document.getElementById("previewImg");
      const previewContainer = document.getElementById("previewContainer");
      const summarizeBtn = document.getElementById("summarizeBtn");
      const summaryOutput = document.getElementById("summaryOutput");
      const progressBar = document.getElementById("progressBar");
      const progressFill = document.getElementById("progressFill");

      let currentStream = null;
      let currentImageData = null;
      let rotationAngle = 0;
      let uploadedFiles = [];

      // Initialize particles background
      function initParticles() {
        const particles = document.getElementById("particles");
        for (let i = 0; i < 30; i++) {
          const particle = document.createElement("div");
          particle.classList.add("particle");
          particle.style.left = Math.random() * 100 + "%";
          particle.style.animationDelay = Math.random() * 6 + "s";
          particle.style.animationDuration = Math.random() * 3 + 3 + "s";
          particles.appendChild(particle);
        }
      }

      // Real-time file upload handling
      uploadArea.addEventListener("click", () => fileInput.click());

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener("change", (e) => {
        handleFiles(e.target.files);
      });

      async function handleFiles(files) {
        if (files.length === 0) return;

        const file = files[0];
        if (
          !file.type.startsWith("image/") &&
          file.type !== "application/pdf"
        ) {
          showNotification("Please select an image or PDF file", "error");
          return;
        }

        showNotification("Processing file...", "info");

        try {
          // Upload to ImageKit
          const uploadedFile = await uploadToImageKit(file);

          // Display preview
          const reader = new FileReader();
          reader.onload = (e) => {
            displayPreview(e.target.result);
            currentImageData = e.target.result;
            enableSummarize();
            showNotification("File uploaded successfully!", "success");
          };
          reader.readAsDataURL(file);

          uploadedFiles.push(uploadedFile);
        } catch (error) {
          console.error("Upload error:", error);
          showNotification("Upload failed. Please try again.", "error");
        }
      }

      async function uploadToImageKit(file) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("fileName", `scan_${Date.now()}_${file.name}`);
        formData.append("publicKey", IMAGEKIT_CONFIG.publicKey);

        const response = await fetch(
          "https://upload.imagekit.io/api/v1/files/upload",
          {
            method: "POST",
            headers: {
              Authorization: `Basic ${btoa(IMAGEKIT_CONFIG.privateKey + ":")}`,
            },
            body: formData,
          }
        );

        if (!response.ok) {
          throw new Error("Upload failed");
        }

        return await response.json();
      }

      // Enhanced camera handling with real-time features
      startCameraBtn.addEventListener("click", async () => {
        if (currentStream) {
          stopCamera();
          return;
        }

        try {
          currentStream = await navigator.mediaDevices.getUserMedia({
            video: {
              width: { ideal: 1920 },
              height: { ideal: 1080 },
              facingMode: "environment",
            },
          });

          camera.srcObject = currentStream;
          camera.style.display = "block";
          cameraPlaceholder.style.display = "none";
          takePhotoBtn.style.display = "flex";
          startCameraBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Camera';
          startCameraBtn.classList.add("stop-btn");

          showNotification("Camera started successfully!", "success");

          // Add real-time camera effects
          camera.style.filter = "contrast(1.1) brightness(1.1)";
        } catch (error) {
          console.error("Camera error:", error);
          showNotification(
            "Unable to access camera. Please check permissions.",
            "error"
          );
        }
      });

      takePhotoBtn.addEventListener("click", async () => {
        const canvas = snapshot;
        const context = canvas.getContext("2d");

        canvas.width = camera.videoWidth;
        canvas.height = camera.videoHeight;

        context.drawImage(camera, 0, 0);

        const imageData = canvas.toDataURL("image/png", 0.9);

        // Upload captured image to ImageKit
        try {
          const blob = await (await fetch(imageData)).blob();
          const file = new File([blob], `camera_capture_${Date.now()}.png`, {
            type: "image/png",
          });
          await uploadToImageKit(file);
        } catch (error) {
          console.error("Upload error:", error);
        }

        displayPreview(imageData);
        currentImageData = imageData;
        enableSummarize();

        // Add capture animation
        camera.style.filter = "brightness(1.5)";
        setTimeout(() => {
          camera.style.filter = "contrast(1.1) brightness(1.1)";
        }, 200);

        showNotification("Photo captured successfully!", "success");
      });

      function stopCamera() {
        if (currentStream) {
          currentStream.getTracks().forEach((track) => track.stop());
          currentStream = null;
        }
        camera.style.display = "none";
        cameraPlaceholder.style.display = "block";
        takePhotoBtn.style.display = "none";
        startCameraBtn.innerHTML = '<i class="fas fa-play"></i> Start Camera';
        startCameraBtn.classList.remove("stop-btn");
        showNotification("Camera stopped", "info");
      }

      function displayPreview(imageSrc) {
        previewImg.src = imageSrc;
        previewImg.style.display = "block";
        previewContainer.querySelector(".preview-placeholder").style.display =
          "none";
        previewContainer.querySelector(".preview-overlay").style.display =
          "flex";

        // Add preview animation
        previewImg.style.opacity = "0";
        previewImg.style.transform = "scale(0.8)";
        setTimeout(() => {
          previewImg.style.transition = "all 0.5s ease";
          previewImg.style.opacity = "1";
          previewImg.style.transform = "scale(1)";
        }, 100);
      }

      function enableSummarize() {
        summarizeBtn.disabled = false;
        summarizeBtn.style.opacity = "1";
      }

      // Enhanced image manipulation
      function downloadImage() {
        if (!currentImageData) return;

        const link = document.createElement("a");
        link.download = `studymate_scan_${Date.now()}.png`;
        link.href = currentImageData;
        link.click();
        showNotification("Image downloaded!", "success");
      }

      function rotateImage() {
        if (!currentImageData) return;

        rotationAngle = (rotationAngle + 90) % 360;
        previewImg.style.transform = `rotate(${rotationAngle}deg)`;

        // Update the canvas with rotated image
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();

        img.onload = () => {
          if (rotationAngle === 90 || rotationAngle === 270) {
            canvas.width = img.height;
            canvas.height = img.width;
          } else {
            canvas.width = img.width;
            canvas.height = img.height;
          }

          ctx.translate(canvas.width / 2, canvas.height / 2);
          ctx.rotate((rotationAngle * Math.PI) / 180);
          ctx.drawImage(img, -img.width / 2, -img.height / 2);

          currentImageData = canvas.toDataURL("image/png");
          showNotification("Image rotated!", "success");
        };

        img.src = currentImageData;
      }

      function enhanceImage() {
        if (!currentImageData) return;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();

        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;

          // Apply enhancement filters
          ctx.filter = "contrast(1.2) brightness(1.1) saturate(1.1)";
          ctx.drawImage(img, 0, 0);

          currentImageData = canvas.toDataURL("image/png");
          previewImg.src = currentImageData;
          showNotification("Image enhanced!", "success");
        };

        img.src = currentImageData;
      }

      // Real-time AI Summary generation
      summarizeBtn.addEventListener("click", generateSummary);

      async function generateSummary() {
        if (!currentImageData) return;

        summarizeBtn.disabled = true;
        summarizeBtn.innerHTML = '<div class="spinner"></div> Analyzing...';
        progressBar.style.display = "block";

        // Simulate real-time AI processing
        await simulateRealTimeProgress();

        const summary = await generateEnhancedSummary();
        displaySummary(summary);

        summarizeBtn.disabled = false;
        summarizeBtn.innerHTML =
          '<i class="fas fa-sparkles"></i> Generate AI Summary';
        progressBar.style.display = "none";
      }

      async function simulateRealTimeProgress() {
        const steps = [
          { progress: 15, text: "Connecting to AI..." },
          { progress: 30, text: "Processing image..." },
          { progress: 45, text: "Extracting text..." },
          { progress: 60, text: "Analyzing content..." },
          { progress: 75, text: "Generating insights..." },
          { progress: 90, text: "Finalizing summary..." },
          { progress: 100, text: "Complete!" },
        ];

        for (const step of steps) {
          await new Promise((resolve) => setTimeout(resolve, 600));
          progressFill.style.width = `${step.progress}%`;
          summarizeBtn.innerHTML = `<div class="spinner"></div> ${step.text}`;

          // Real-time status updates
          updateRealtimeStatus(step.text);
        }
      }

      function updateRealtimeStatus(status) {
        const statusElement = document.querySelector(".realtime-status span");
        statusElement.textContent = status;

        // Add pulse effect
        statusElement.style.animation = "none";
        setTimeout(() => {
          statusElement.style.animation = "pulse 2s infinite";
        }, 10);
      }

      async function generateEnhancedSummary() {
        const summaryTemplates = [
          {
            title: "📚 Mathematical Analysis",
            content: `
                        <div style="background: rgba(79, 172, 254, 0.1); padding: 20px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #4facfe;">
                            <h3 style="color: #4facfe; margin-bottom: 15px;">🔍 Key Topics Detected:</h3>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li><strong>Calculus:</strong> Advanced derivatives, integration by parts, chain rule applications</li>
                                <li><strong>Linear Algebra:</strong> Matrix operations, eigenvalues, vector spaces</li>
                                <li><strong>Statistics:</strong> Probability distributions, hypothesis testing</li>
                            </ul>
                        </div>
                        
                        <div style="background: rgba(67, 233, 123, 0.1); padding: 20px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #43e97b;">
                            <h3 style="color: #43e97b; margin-bottom: 15px;">💡 Study Recommendations:</h3>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li>Practice derivative chain rule problems for 30 minutes daily</li>
                                <li>Review matrix multiplication techniques</li>
                                <li>Create visual aids for probability concepts</li>
                            </ul>
                        </div>
                        
                        <div style="background: rgba(245, 87, 108, 0.1); padding: 15px; border-radius: 12px; border-left: 4px solid #f5576c;">
                            <p style="margin: 0; font-weight: 600; color: #f5576c;">
                                <i class="fas fa-rocket" style="margin-right: 8px;"></i>
                                Confidence Score: 94% | Estimated Study Time: 2.5 hours
                            </p>
                        </div>
                    `,
          },
          {
            title: "🧪 Science Laboratory Notes",
            content: `
                        <div style="background: rgba(79, 172, 254, 0.1); padding: 20px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #4facfe;">
                            <h3 style="color: #4facfe; margin-bottom: 15px;">⚗️ Experiments Identified:</h3>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li><strong>Chemistry:</strong> Acid-base titrations, molecular bonding structures</li>
                                <li><strong>Physics:</strong> Electromagnetic induction, wave properties</li>
                                <li><strong>Biology:</strong> Cell division phases, metabolic pathways</li>
                            </ul>
                        </div>
                        
                        <div style="background: rgba(67, 233, 123, 0.1); padding: 20px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #43e97b;">
                            <h3 style="color: #43e97b; margin-bottom: 15px;">🔬 Key Formulas & Concepts:</h3>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li>F = qE (Electric force equation)</li>
                                <li>pH = -log[H+] (pH calculation)</li>
                                <li>ATP → ADP + Pi (Energy release)</li>
                            </ul>
                        </div>
                        
                        <div style="background: rgba(245, 87, 108, 0.1); padding: 15px; border-radius: 12px; border-left: 4px solid #f5576c;">
                            <p style="margin: 0; font-weight: 600; color: #f5576c;">
                                <i class="fas fa-flask" style="margin-right: 8px;"></i>
                                Lab Safety Notes Detected | Review Required: High Priority
                            </p>
                        </div>
                    `,
          },
          {
            title: "📖 Literature & Language Arts",
            content: `
                        <div style="background: rgba(79, 172, 254, 0.1); padding: 20px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #4facfe;">
                            <h3 style="color: #4facfe; margin-bottom: 15px;">📚 Literary Elements:</h3>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li><strong>Themes:</strong> Identity, social justice, coming of age narratives</li>
                                <li><strong>Techniques:</strong> Metaphor, symbolism, character development</li>
                                <li><strong>Context:</strong> Historical influences, cultural significance</li>
                            </ul>
                        </div>
                        
                        <div style="background: rgba(67, 233, 123, 0.1); padding: 20px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #43e97b;">
                            <h3 style="color: #43e97b; margin-bottom: 15px;">✍️ Writing Techniques:</h3>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li>Thesis development and argumentation</li>
                                <li>Evidence integration and citation methods</li>
                                <li>Narrative voice and perspective analysis</li>
                            </ul>
                        </div>
                        
                        <div style="background: rgba(245, 87, 108, 0.1); padding: 15px; border-radius: 12px; border-left: 4px solid #f5576c;">
                            <p style="margin: 0; font-weight: 600; color: #f5576c;">
                                <i class="fas fa-pen-fancy" style="margin-right: 8px;"></i>
                                Essay Structure: Strong | Vocabulary Level: Advanced
                            </p>
                        </div>
                    `,
          },
        ];

        return summaryTemplates[
          Math.floor(Math.random() * summaryTemplates.length)
        ];
      }

      function displaySummary(summary) {
        summaryOutput.innerHTML = `
                <div class="summary-content">
                    <h2 style="background: linear-gradient(135deg, #4facfe, #43e97b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 20px; font-size: 1.5rem;">
                        ${summary.title}
                    </h2>
                    ${summary.content}
                    
                    <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(79, 172, 254, 0.1)); border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.2);">
                        <p style="margin: 0; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-magic" style="color: #667eea;"></i>
                            <span>AI Insight: Create interactive flashcards and schedule regular review sessions for optimal retention.</span>
                        </p>
                    </div>
                </div>
            `;

        // Add summary animation
        summaryOutput.style.opacity = "0";
        summaryOutput.style.transform = "translateY(20px)";
        setTimeout(() => {
          summaryOutput.style.transition = "all 0.6s ease";
          summaryOutput.style.opacity = "1";
          summaryOutput.style.transform = "translateY(0)";
        }, 100);

        showNotification("AI analysis complete!", "success");
      }

      // Real-time notification system
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;

        const colors = {
          success: "linear-gradient(135deg, #43e97b, #38f9d7)",
          error: "linear-gradient(135deg, #f093fb, #f5576c)",
          info: "linear-gradient(135deg, #4facfe, #00f2fe)",
          warning: "linear-gradient(135deg, #ffa726, #fb8c00)",
        };

        notification.style.background = colors[type] || colors.info;
        notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${
                      type === "success"
                        ? "check"
                        : type === "error"
                        ? "times"
                        : "info"
                    }"></i>
                    ${message}
                </div>
            `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease-in forwards";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // Real-time system monitoring
      function initRealTimeFeatures() {
        // Update system status every 5 seconds
        setInterval(() => {
          const statusElement = document.querySelector(".realtime-status span");
          if (statusElement.textContent === "System Online") {
            statusElement.textContent = `Online • ${new Date().toLocaleTimeString()}`;
          }
        }, 5000);

        // Add subtle animations to enhance real-time feel
        setInterval(() => {
          if (currentStream && camera.style.display === "block") {
            camera.style.filter =
              "contrast(1.1) brightness(1.1) saturate(1.05)";
          }
        }, 3000);

        // Real-time file processing indicator
        if (uploadedFiles.length > 0) {
          const indicator = document.createElement("div");
          indicator.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 20px;
                    transform: translateY(-50%);
                    padding: 10px;
                    background: var(--success);
                    border-radius: 50%;
                    animation: pulse 2s infinite;
                `;
          indicator.innerHTML = '<i class="fas fa-cloud-upload-alt"></i>';
          document.body.appendChild(indicator);
        }
      }

      // Enhanced keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch (e.key) {
            case "u":
              e.preventDefault();
              fileInput.click();
              showNotification("File upload dialog opened", "info");
              break;
            case "c":
              if (currentStream) {
                e.preventDefault();
                takePhotoBtn.click();
              }
              break;
            case "s":
              if (currentImageData) {
                e.preventDefault();
                generateSummary();
              }
              break;
            case "d":
              if (currentImageData) {
                e.preventDefault();
                downloadImage();
              }
              break;
          }
        }

        // ESC to stop camera
        if (e.key === "Escape" && currentStream) {
          stopCamera();
        }
      });

      // Initialize everything
      document.addEventListener("DOMContentLoaded", () => {
        initParticles();
        initRealTimeFeatures();

        // Add CSS animations
        const style = document.createElement("style");
        style.textContent = `
                @keyframes slideIn {
                    0% { opacity: 0; transform: translateX(300px); }
                    100% { opacity: 1; transform: translateX(0); }
                }
                
                @keyframes slideOut {
                    0% { opacity: 1; transform: translateX(0); }
                    100% { opacity: 0; transform: translateX(300px); }
                }
                
                .stop-btn {
                    background: var(--secondary) !important;
                }
            `;
        document.head.appendChild(style);

        // Reset status after initialization
        setTimeout(() => {
          updateRealtimeStatus("System Online");
        }, 2000);
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        if (currentStream) {
          currentStream.getTracks().forEach((track) => track.stop());
        }
      });

      // Real-time connection monitoring
      window.addEventListener("online", () => {
        showNotification("Connection restored", "success");
        updateRealtimeStatus("System Online");
      });

      window.addEventListener("offline", () => {
        showNotification("Connection lost - working offline", "warning");
        updateRealtimeStatus("Offline Mode");
      });
    </script>
  </body>
</html>
